# ğŸ”§ LifeBit ë¡œê·¸ì¸ 400 ì—ëŸ¬ í•´ê²° ë³´ê³ ì„œ

## ğŸ“‹ ë¬¸ì œ ê°œìš”
- **ë°œìƒ ì¼ì‹œ**: 2025-06-17
- **ì˜¤ë¥˜ ìœ í˜•**: HTTP 400 Bad Request
- **ì˜í–¥ ë²”ìœ„**: ì‚¬ìš©ì ë¡œê·¸ì¸ ê¸°ëŠ¥ ì „ì²´ ë¶ˆê°€
- **ì˜¤ë¥˜ ë©”ì‹œì§€**: 
  ```
  :8080/api/auth/login:1 Failed to load resource: the server responded with a status of 400 ()
  axios.ts:37 Response error: Object
  auth.ts:48 Login failed: AxiosError
  ```

---

## ğŸ” ì›ì¸ ë¶„ì„

### 1ï¸âƒ£ **ì£¼ìš” ì›ì¸: ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ë¬¸ì œ**
```yaml
# ë¬¸ì œê°€ ëœ ì„¤ì • (application.yml)
spring:
  datasource:
    url: jdbc:h2:mem:testdb  # âŒ H2 ì¸ë©”ëª¨ë¦¬ DB ì‚¬ìš©
    username: sa
    password: 
    driver-class-name: org.h2.Driver
```

**ë¬¸ì œì **: 
- ì‹¤ì œ PostgreSQLì— ì‚¬ìš©ì ë°ì´í„°ê°€ ìˆì§€ë§Œ, ì• í”Œë¦¬ì¼€ì´ì…˜ì€ H2 ì¸ë©”ëª¨ë¦¬ DB ì‚¬ìš©
- H2ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ì¬ì‹œì‘ ì‹œ ë°ì´í„° ì´ˆê¸°í™”ë¨
- ë¡œê·¸ì¸ ì‹œ ì‚¬ìš©ì ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ 400 ì—ëŸ¬ ë°œìƒ

### 2ï¸âƒ£ **ë¶€ì°¨ì  ì›ì¸ë“¤**

#### A. í™˜ê²½ ë³€ìˆ˜ ë¯¸ì„¤ì •
```typescript
// í”„ë¡ íŠ¸ì—”ë“œì—ì„œ API URLì´ undefinedì¼ ê°€ëŠ¥ì„±
export const API_CONFIG = {
    BASE_URL: import.meta.env.VITE_CORE_API_URL || 'http://localhost:8080',
    // âŒ .env íŒŒì¼ì´ ì—†ì–´ì„œ undefined ê°€ëŠ¥ì„±
};
```

#### B. UserRepository ì»¤ìŠ¤í…€ ì¿¼ë¦¬ ë¬¸ì œ
```java
// ë¬¸ì œê°€ ëœ ì½”ë“œ
@Query(value = """
    INSERT INTO users (email, nickname, password_hash, role, uuid, created_at, updated_at)
    VALUES (:email, :nickname, :passwordHash, CAST(:role AS user_role), :uuid, :createdAt, :updatedAt)
    RETURNING *
    """, nativeQuery = true)
User saveWithRole(...);  // âŒ ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬ë¡œ ì¸í•œ JPA ì¶©ëŒ ê°€ëŠ¥ì„±
```

#### C. PostgreSQL ì„œë²„ ë¯¸ì‹¤í–‰
- Docker Composeë¡œ ì •ì˜ëœ PostgreSQLì´ ì‹¤í–‰ë˜ì§€ ì•Šì€ ìƒíƒœ
- ì—°ê²° ì‹œë„ ì‹œ Connection Refused ë°œìƒ

---

## ğŸ› ï¸ í•´ê²° ì¡°ì¹˜ ì‚¬í•­

### 1ë‹¨ê³„: í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
```bash
# ìƒì„±ëœ íŒŒì¼: apps/frontend-vite/.env
VITE_CORE_API_URL=http://localhost:8080
VITE_AI_API_URL=http://localhost:8001
VITE_GOOGLE_CLIENT_ID=
VITE_KAKAO_CLIENT_ID=
```

**ëª©ì **: í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì •í™•í•œ API URL ì‚¬ìš© ë³´ì¥

### 2ë‹¨ê³„: PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ ë³µì›
```yaml
# ìˆ˜ì •ëœ application.yml
spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/lifebit_db  # âœ… PostgreSQL ì—°ê²°
    username: lifebit_user
    password: lifebit_password
    driver-class-name: org.postgresql.Driver
  jpa:
    hibernate:
      ddl-auto: validate  # âœ… ê¸°ì¡´ ìŠ¤í‚¤ë§ˆ ê²€ì¦ë§Œ ìˆ˜í–‰
```

**ë³€ê²½ ì‚¬ìœ **: 
- ì‹¤ì œ ì‚¬ìš©ì ë°ì´í„°ê°€ ìˆëŠ” PostgreSQL ì‚¬ìš©
- `validate` ëª¨ë“œë¡œ ê¸°ì¡´ í…Œì´ë¸” êµ¬ì¡° ë³´ì¡´

### 3ë‹¨ê³„: PostgreSQL ì„œë²„ ì‹¤í–‰
```bash
# Docker Composeë¡œ PostgreSQL ì‹¤í–‰
docker-compose up -d postgres-db

# ìŠ¤í‚¤ë§ˆ ìƒì„± (ê¸°ì¡´ í…Œì´ë¸”ì´ ì—†ì„ ê²½ìš°)
docker exec -i lifebit_postgres psql -U lifebit_user -d lifebit_db < LifeBit.SQL
```

**ê²°ê³¼**: 
- PostgreSQL ì»¨í…Œì´ë„ˆ ì •ìƒ ì‹¤í–‰
- 16ê°œ í…Œì´ë¸” ìƒì„± ì™„ë£Œ
- ì‚¬ìš©ì ë°ì´í„° 7ëª… í™•ì¸

### 4ë‹¨ê³„: UserRepository ìµœì í™”
```java
// ì œê±°ëœ ë¬¸ì œ ì½”ë“œ
@Query(value = """
    INSERT INTO users (email, nickname, password_hash, role, uuid, created_at, updated_at)
    VALUES (:email, :nickname, :passwordHash, CAST(:role AS user_role), :uuid, :createdAt, :updatedAt)
    RETURNING *
    """, nativeQuery = true)
User saveWithRole(...);  // âŒ ì œê±°ë¨

// ê°œì„ ëœ ì½”ë“œ
public interface UserRepository extends JpaRepository<User, Long> {
    Optional<User> findByEmail(String email);
    boolean existsByEmail(String email);
    boolean existsByNickname(String nickname);
    // âœ… í‘œì¤€ JPA save() ë©”ì„œë“œ ì‚¬ìš©
}
```

### 5ë‹¨ê³„: UserService ë¦¬íŒ©í† ë§
```java
// ê¸°ì¡´ ë¬¸ì œ ì½”ë“œ
@Transactional
public User signUp(SignUpRequest request) {
    // ê²€ì¦ ë¡œì§...
    LocalDateTime now = LocalDateTime.now();
    return userRepository.saveWithRole(  // âŒ ì»¤ìŠ¤í…€ ë©”ì„œë“œ ì‚¬ìš©
        request.getEmail(),
        request.getNickname(),
        passwordEncoder.encode(request.getPassword()),
        "USER",
        UUID.randomUUID(),
        now,
        now
    );
}

// ê°œì„ ëœ ì½”ë“œ
@Transactional
public User signUp(SignUpRequest request) {
    // ê²€ì¦ ë¡œì§...
    User user = new User();
    user.setEmail(request.getEmail());
    user.setNickname(request.getNickname());
    user.setPasswordHash(passwordEncoder.encode(request.getPassword()));
    // âœ… @PrePersistì—ì„œ uuid, role, timestamps ìë™ ì„¤ì •
    
    return userRepository.save(user);  // âœ… í‘œì¤€ JPA save() ì‚¬ìš©
}
```

**ê°œì„  íš¨ê³¼**:
- JPA í‘œì¤€ ë°©ì‹ ì‚¬ìš©ìœ¼ë¡œ ì•ˆì •ì„± í–¥ìƒ
- Entityì˜ `@PrePersist` ì–´ë…¸í…Œì´ì…˜ í™œìš©
- ì½”ë“œ ë³µì¡ë„ ê°ì†Œ

### 6ë‹¨ê³„: Spring Security ì„¤ì • ë³´ì™„
```java
// SecurityConfig.javaì— ì¶”ê°€
.authorizeHttpRequests(auth -> auth
    .requestMatchers(
        "/api/auth/**", 
        "/actuator/**", 
        "/",
        "/api/health/**",            // âœ… í—¬ìŠ¤ì²´í¬ API ì¶”ê°€
        "/api/health-statistics/**",
        // ... ê¸°íƒ€ ì—”ë“œí¬ì¸íŠ¸ë“¤
    ).permitAll()
    .anyRequest().authenticated()
)
```

**ëª©ì **: ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ìƒíƒœ í™•ì¸ì„ ìœ„í•œ í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ í—ˆìš©

### 7ë‹¨ê³„: ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í…ŒìŠ¤íŠ¸ ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€
```java
// HealthCheckController.java ê°œì„ 
@RestController
@RequiredArgsConstructor
public class HealthCheckController {
    private final UserRepository userRepository;
    
    @GetMapping("/api/health/db")
    public Map<String, Object> dbHealthCheck() {
        try {
            long userCount = userRepository.count();  // âœ… DB ì—°ê²° í…ŒìŠ¤íŠ¸
            return Map.of(
                "status", "OK", 
                "database", "Connected",
                "userCount", userCount
            );
        } catch (Exception e) {
            return Map.of(
                "status", "ERROR", 
                "database", "Connection Failed",
                "error", e.getMessage()
            );
        }
    }
}
```

**ê¸°ëŠ¥**: ì‹¤ì‹œê°„ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ìƒíƒœ ë° ì‚¬ìš©ì ìˆ˜ í™•ì¸

### 8ë‹¨ê³„: ë¡œê¹… ë ˆë²¨ ê°•í™”
```yaml
# application.ymlì— ì¶”ê°€
logging:
  level:
    com.lifebit: DEBUG                    # âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸
    org.springframework.web: DEBUG        # âœ… ì›¹ ìš”ì²­ ë¡œê·¸
    org.springframework.security: DEBUG   # âœ… ë³´ì•ˆ ë¡œê·¸
    org.hibernate.SQL: DEBUG             # âœ… SQL ì¿¼ë¦¬ ë¡œê·¸
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE  # âœ… SQL íŒŒë¼ë¯¸í„° ë¡œê·¸
```

**íš¨ê³¼**: ë¬¸ì œ ë°œìƒ ì‹œ ìƒì„¸í•œ ë””ë²„ê¹… ì •ë³´ ì œê³µ

---

## âœ… í•´ê²° ê²°ê³¼

### 1. ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í™•ì¸
```bash
# í…ŒìŠ¤íŠ¸ ê²°ê³¼
PS> Invoke-RestMethod -Uri "http://localhost:8080/api/health/db" -Method GET

userCount database  status
--------- --------  ------
        7 Connected OK
```

### 2. ì‚¬ìš©ì ë°ì´í„° í™•ì¸
```sql
-- PostgreSQLì—ì„œ í™•ì¸ëœ ì‚¬ìš©ì ë°ì´í„°
SELECT user_id, email, nickname, role FROM users;
/*
 user_id |     email      | nickname | role  
---------+----------------+----------+-------
       1 | admin@lifebit.com | ê´€ë¦¬ì | ADMIN
       2 | user1@example.com | í™ê¸¸ë™ | USER
       3 | user2@example.com | ê¹€ì² ìˆ˜ | USER
       4 | user3@example.com | ì´ì˜í¬ | USER
       5 | user4@example.com | ë°•ì§€ë¯¼ | USER
       6 | test@test.com  | testuser | USER
       7 | admin@test.com | admin    | ADMIN
*/
```

### 3. í…ŒìŠ¤íŠ¸ ê³„ì • ì •ë³´
```
í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì:
- ì´ë©”ì¼: test@test.com
- ë¹„ë°€ë²ˆí˜¸: password
- ì—­í• : USER

ê´€ë¦¬ì ê³„ì •:
- ì´ë©”ì¼: admin@test.com  
- ë¹„ë°€ë²ˆí˜¸: password
- ì—­í• : ADMIN
```

---

## ğŸ¯ ì„±ëŠ¥ ê°œì„  íš¨ê³¼

### Before (ë¬¸ì œ ìƒí™©)
- âŒ ë¡œê·¸ì¸ ì‹œ 400 ì—ëŸ¬ ë°œìƒ
- âŒ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ë¶ˆì•ˆì •
- âŒ ì‚¬ìš©ì ë°ì´í„° ì ‘ê·¼ ë¶ˆê°€
- âŒ ë””ë²„ê¹… ì •ë³´ ë¶€ì¡±

### After (í•´ê²° í›„)
- âœ… ë¡œê·¸ì¸ ì •ìƒ ì‘ë™
- âœ… PostgreSQL ì•ˆì •ì  ì—°ê²°
- âœ… 7ëª… ì‚¬ìš©ì ë°ì´í„° í™œìš© ê°€ëŠ¥
- âœ… ì‹¤ì‹œê°„ DB ìƒíƒœ ëª¨ë‹ˆí„°ë§
- âœ… ìƒì„¸í•œ ë¡œê¹…ìœ¼ë¡œ ë¬¸ì œ ì¶”ì  ê°€ëŠ¥

---

## ğŸ“š í•™ìŠµëœ êµí›ˆ

### 1. **ë°ì´í„°ë² ì´ìŠ¤ í™˜ê²½ ì¼ê´€ì„±ì˜ ì¤‘ìš”ì„±**
- ê°œë°œ/í…ŒìŠ¤íŠ¸/ìš´ì˜ í™˜ê²½ì—ì„œ ë™ì¼í•œ DB ì—”ì§„ ì‚¬ìš© í•„ìš”
- ì¸ë©”ëª¨ë¦¬ DBëŠ” í…ŒìŠ¤íŠ¸ ëª©ì ìœ¼ë¡œë§Œ ì‚¬ìš©

### 2. **JPA í‘œì¤€ ë°©ì‹ ì¤€ìˆ˜**
- ì»¤ìŠ¤í…€ ë„¤ì´í‹°ë¸Œ ì¿¼ë¦¬ë³´ë‹¤ í‘œì¤€ JPA ë°©ì‹ ì„ í˜¸
- Entity ìƒëª…ì£¼ê¸° ì–´ë…¸í…Œì´ì…˜(`@PrePersist`, `@PreUpdate`) ì ê·¹ í™œìš©

### 3. **í™˜ê²½ ë³€ìˆ˜ ê´€ë¦¬ì˜ ì¤‘ìš”ì„±**
- ëª¨ë“  í™˜ê²½ë³„ ì„¤ì •ì€ í™˜ê²½ ë³€ìˆ˜ë¡œ ë¶„ë¦¬
- `.env.example` íŒŒì¼ë¡œ í•„ìš”í•œ ë³€ìˆ˜ ë¬¸ì„œí™”

### 4. **ëª¨ë‹ˆí„°ë§ ì—”ë“œí¬ì¸íŠ¸ì˜ í•„ìš”ì„±**
- í—¬ìŠ¤ì²´í¬ APIë¡œ ì‹¤ì‹œê°„ ìƒíƒœ í™•ì¸
- ì ì ˆí•œ ë¡œê¹… ë ˆë²¨ë¡œ ë¬¸ì œ ì¶”ì  ìš©ì´ì„± í™•ë³´

---

## ğŸ”® í–¥í›„ ê°œì„  ë°©ì•ˆ

### 1. **ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… ë° ë³µêµ¬ ì²´ê³„**
```bash
# ì •ê¸° ë°±ì—… ìŠ¤í¬ë¦½íŠ¸ ì˜ˆì‹œ
docker exec lifebit_postgres pg_dump -U lifebit_user lifebit_db > backup_$(date +%Y%m%d).sql
```

### 2. **í™˜ê²½ë³„ í”„ë¡œíŒŒì¼ ë¶„ë¦¬**
```yaml
# application-dev.yml (ê°œë°œí™˜ê²½)
spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/lifebit_dev
    
# application-prod.yml (ìš´ì˜í™˜ê²½)  
spring:
  datasource:
    url: jdbc:postgresql://prod-server:5432/lifebit_prod
```

### 3. **API ì‘ë‹µ í‘œì¤€í™”**
```java
// í‘œì¤€ API ì‘ë‹µ í˜•ì‹
public class ApiResponse<T> {
    private boolean success;
    private String message;
    private T data;
    private String timestamp;
}
```

### 4. **í†µí•© í…ŒìŠ¤íŠ¸ í™˜ê²½ êµ¬ì¶•**
```java
@SpringBootTest
@Testcontainers
class AuthControllerIntegrationTest {
    @Container
    static PostgreSQLContainer<?> postgres = new PostgreSQLContainer<>("postgres:16");
    
    @Test
    void ë¡œê·¸ì¸_ì„±ê³µ_í…ŒìŠ¤íŠ¸() {
        // í†µí•© í…ŒìŠ¤íŠ¸ ì½”ë“œ
    }
}
```

---

## ğŸ“ ë¬¸ì˜ ë° ì§€ì›

- **ê¸°ìˆ  ë¬¸ì˜**: ê°œë°œíŒ€
- **ê¸´ê¸‰ ìƒí™©**: ì‹œìŠ¤í…œ ê´€ë¦¬ì
- **ë¬¸ì„œ ì—…ë°ì´íŠ¸**: 2025-06-17

---

**âœ¨ ì´ ë¬¸ì„œëŠ” í–¥í›„ ìœ ì‚¬í•œ ë¬¸ì œ ë°œìƒ ì‹œ ë¹ ë¥¸ í•´ê²°ì„ ìœ„í•œ ì°¸ê³  ìë£Œë¡œ í™œìš©í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.** 