---
# ================================================
# LifeBit í•™ì›ìš© Ansible ë°°í¬ í”Œë ˆì´ë¶
# ================================================
# ë‹¨ì¼ ì„œë²„ì— Docker Composeë¡œ ëª¨ë“  ì„œë¹„ìŠ¤ ë°°í¬

- name: LifeBit ì™„ì „ ìë™í™” ë°°í¬
  hosts: all
  become: yes
  vars:
    project_name: "lifebit"
    environment: "{{ env | default('demo') }}"
    git_repo: "{{ git_repository_url | default('https://github.com/your-repo/LifeBit.git') }}"
    
  tasks:
    # ================================================
    # 1. ì‹œìŠ¤í…œ ê¸°ë³¸ ì„¤ì •
    # ================================================
    - name: ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸
      apt:
        update_cache: yes
        upgrade: dist
        cache_valid_time: 3600
      tags: [system]

    - name: í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜
      apt:
        name:
          - curl
          - wget
          - git
          - vim
          - htop
          - unzip
          - zip
          - jq
          - tree
          - net-tools
          - ufw
          - fail2ban
          - logrotate
          - cron
          - software-properties-common
          - apt-transport-https
          - ca-certificates
          - gnupg
          - lsb-release
          - bc
          - netcat
          - python3
          - python3-pip
          - python3-dev
          - python3-setuptools
        state: present
      tags: [system]

    # ================================================
    # 2. Docker ì„¤ì¹˜
    # ================================================
    - name: Docker GPG í‚¤ ì¶”ê°€
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present
      tags: [docker]

    - name: Docker ì €ì¥ì†Œ ì¶”ê°€
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present
      tags: [docker]

    - name: Docker ì„¤ì¹˜
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
        state: present
        update_cache: yes
      tags: [docker]

    - name: Docker ì„œë¹„ìŠ¤ ì‹œì‘ ë° í™œì„±í™”
      systemd:
        name: docker
        state: started
        enabled: yes
      tags: [docker]

    - name: Docker Compose ì„¤ì¹˜
      get_url:
        url: "https://github.com/docker/compose/releases/latest/download/docker-compose-Linux-x86_64"
        dest: /usr/local/bin/docker-compose
        mode: '0755'
      tags: [docker]

    - name: Docker ì‚¬ìš©ì ê·¸ë£¹ ì„¤ì •
      user:
        name: "{{ item }}"
        groups: docker
        append: yes
      loop:
        - root
        - ubuntu
      ignore_errors: yes
      tags: [docker]

    - name: Docker SDK(Python) ë° Compose ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
      pip:
        name:
          - docker  # docker SDKë§Œ ì„¤ì¹˜í•˜ì—¬ docker-compose v1ì´ ì„¤ì¹˜ë˜ì§€ ì•Šë„ë¡ í•¨
        state: present
        executable: pip3
      tags: [docker]

    # ================================================
    # 3. ë°©í™”ë²½ ì„¤ì •
    # ================================================
    - name: UFW ì´ˆê¸°í™”
      ufw:
        state: reset
      tags: [security]

    - name: UFW ê¸°ë³¸ ì •ì±… ì„¤ì •
      ufw:
        direction: "{{ item.direction }}"
        policy: "{{ item.policy }}"
      loop:
        - { direction: 'incoming', policy: 'deny' }
        - { direction: 'outgoing', policy: 'allow' }
      tags: [security]

    - name: UFW í¬íŠ¸ í—ˆìš©
      ufw:
        rule: allow
        port: "{{ item.port }}"
        proto: "{{ item.proto | default('tcp') }}"
        comment: "{{ item.comment }}"
      loop:
        - { port: '22', comment: 'SSH' }
        - { port: '80', comment: 'HTTP' }
        - { port: '443', comment: 'HTTPS' }
        - { port: '3000', comment: 'Frontend' }
        - { port: '8080', comment: 'Spring Boot API' }
        - { port: '8001', comment: 'FastAPI' }
        - { port: '8081', comment: 'Airflow' }
        - { port: '8082', comment: 'Nginx Proxy' }
        - { port: '3001', comment: 'Grafana' }
        - { port: '9090', comment: 'Prometheus' }
        - { port: '9100', comment: 'Node Exporter' }
      tags: [security]

    - name: UFW í™œì„±í™”
      ufw:
        state: enabled
      tags: [security]

    # ================================================
    # 4. SSH í‚¤ ì¸ì¦ ì„¤ì • (Ubuntu 24.04 cloud-init ëŒ€ì‘)
    # ================================================
    - name: SSH í‚¤ ì¸ì¦ í™œì„±í™” (cloud-init ë¬´ì‹œ)
      lineinfile:
        path: /etc/ssh/sshd_config.d/50-cloud-init.conf
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        create: yes
        backup: yes
      loop:
        - { regexp: '^PasswordAuthentication', line: 'PasswordAuthentication no' }
        - { regexp: '^PubkeyAuthentication', line: 'PubkeyAuthentication yes' }
        - { regexp: '^ChallengeResponseAuthentication', line: 'ChallengeResponseAuthentication no' }
        - { regexp: '^UsePAM', line: 'UsePAM no' }
        - { regexp: '^PermitRootLogin', line: 'PermitRootLogin prohibit-password' }
      notify: restart ssh
      tags: [security, ssh]

    - name: SSH í‚¤ ì¸ì¦ í™œì„±í™” (ê¸°ë³¸ ì„¤ì •)
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        backup: yes
      loop:
        - { regexp: '^#?PasswordAuthentication', line: 'PasswordAuthentication no' }
        - { regexp: '^#?PubkeyAuthentication', line: 'PubkeyAuthentication yes' }
        - { regexp: '^#?ChallengeResponseAuthentication', line: 'ChallengeResponseAuthentication no' }
        - { regexp: '^#?PermitRootLogin', line: 'PermitRootLogin prohibit-password' }
      notify: restart ssh
      tags: [security, ssh]

    - name: root ì‚¬ìš©ì .ssh ë””ë ‰í† ë¦¬ í™•ì¸
      file:
        path: /root/.ssh
        state: directory
        owner: root
        group: root
        mode: '0700'
      tags: [security, ssh]

    - name: authorized_keys íŒŒì¼ ê¶Œí•œ ì„¤ì •
      file:
        path: /root/.ssh/authorized_keys
        owner: root
        group: root
        mode: '0600'
      ignore_errors: yes
      tags: [security, ssh]

    # ================================================
    # 5. Fail2Ban ì„¤ì •
    # ================================================
    - name: Fail2Ban ì„¤ì • íŒŒì¼ ìƒì„±
      copy:
        content: |
          [DEFAULT]
          bantime = 3600
          findtime = 600
          maxretry = 5
          backend = systemd

          [sshd]
          enabled = true
          port = ssh
          logpath = %(sshd_log)s
          backend = %(sshd_backend)s

          [nginx-http-auth]
          enabled = true
          port = http,https
          logpath = /var/log/nginx/error.log
        dest: /etc/fail2ban/jail.local
        backup: yes
      tags: [security]

    - name: Fail2Ban ì„œë¹„ìŠ¤ ì‹œì‘
      systemd:
        name: fail2ban
        state: started
        enabled: yes
      tags: [security]

    # ================================================
    # 6. Git ì†ŒìŠ¤ í´ë¡ 
    # ================================================
    - name: ê¸°ì¡´ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì‚­ì œ (ì´ˆê¸°í™”)
      file:
        path: "/opt/{{ project_name }}"
        state: absent
      tags: [deploy]

    - name: Git ì €ì¥ì†Œ í´ë¡ 
      git:
        repo: "{{ git_repo }}"
        dest: "/opt/{{ project_name }}"
        version: "{{ git_branch }}"
        force: yes
      tags: [deploy]

    # ================================================
    # 7. í™˜ê²½ ì„¤ì • íŒŒì¼ ìƒì„±
    # ================================================
    - name: .env ë° docker-compose.yml íŒŒì¼ í…œí”Œë¦¿ìœ¼ë¡œ ìƒì„±
      template:
        src: "templates/{{ item.src }}"
        dest: "/opt/{{ project_name }}/{{ item.dest }}"
      loop:
        - { src: 'env.j2', dest: '.env' }
        - { src: 'docker-compose.yml.j2', dest: 'docker-compose.yml' }
      tags: [deploy]

    # ================================================
    # 8. Docker Compose ì‹¤í–‰
    # ================================================
    - name: Docker Composeë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ë° ì‹¤í–‰
      shell: |
        set -e
        cd /opt/{{ project_name }}

        echo "--- Docker ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë¹Œë“œí•˜ê³  ì‹œì‘í•©ë‹ˆë‹¤. ---"
        docker-compose up -d --build --remove-orphans
        
        echo "--- ë°°í¬ ì™„ë£Œ. 30ì´ˆ í›„ ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ ---"
        sleep 30
        docker-compose ps
      args:
        chdir: "/opt/{{ project_name }}"
      register: docker_compose_result
      failed_when: docker_compose_result.rc != 0
      tags: [deploy]

    - name: Docker Compose ìƒíƒœ ì¶œë ¥
      debug:
        var: docker_compose_result.stdout_lines
      tags: [deploy]

    # ================================================
    # 9-1. PostgreSQL DB ì´ˆê¸°í™” (LifeBit.sql ì ìš©)
    # ================================================
    - name: PostgreSQL ì»¨í…Œì´ë„ˆê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°
      wait_for:
        host: "{{ ansible_default_ipv4.address }}"
        port: 5432
        timeout: 60
      tags: [database]

    - name: LifeBit.sql íŒŒì¼ì„ ì„œë²„ë¡œ ë³µì‚¬
      copy:
        src: "{{ playbook_dir }}/../LifeBit.sql"
        dest: "/opt/{{ project_name }}/LifeBit.sql"
        mode: '0644'
      tags: [database]

    - name: PostgreSQL DB ì´ˆê¸°í™” (LifeBit.sql ì‹¤í–‰)
      shell: |
        cd /opt/{{ project_name }}
        docker-compose exec -T postgres-db psql -U {{ postgres_user | default('lifebit_user') }} -d {{ postgres_db | default('lifebit_db') }} < /opt/{{ project_name }}/LifeBit.sql
      args:
        chdir: "/opt/{{ project_name }}"
      register: db_init_result
      failed_when: db_init_result.rc != 0
      tags: [database]

    - name: DB ì´ˆê¸°í™” ê²°ê³¼ ì¶œë ¥
      debug:
        var: db_init_result.stdout_lines
      tags: [database]

    # ================================================
    # 11. í—¬ìŠ¤ì²´í¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (ê°œì„ ëœ ë²„ì „)
    # ================================================
    - name: í—¬ìŠ¤ì²´í¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (ê°œì„ ëœ ë²„ì „)
      copy:
        content: |
          #!/bin/bash
          # LifeBit í—¬ìŠ¤ì²´í¬ ìŠ¤í¬ë¦½íŠ¸ (ê°œì„ ëœ ë²„ì „)
          
          LOG_FILE="/opt/{{ project_name }}/logs/health-check.log"
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
          
          # ë¡œê·¸ í•¨ìˆ˜
          log_message() {
              echo "[$TIMESTAMP] $1" >> "$LOG_FILE"
          }
          
          # ì‹œìŠ¤í…œ ì„œë¹„ìŠ¤ í™•ì¸
          SERVICES=("docker" "nginx" "fail2ban" "node_exporter")
          FAILED_SERVICES=()
          
          log_message "=== í—¬ìŠ¤ì²´í¬ ì‹œì‘ ==="
          
          for service in "${SERVICES[@]}"; do
              if systemctl is-active --quiet "$service"; then
                  log_message "âœ“ $service: ì •ìƒ"
              else
                  log_message "âœ— $service: ì‹¤íŒ¨"
                  FAILED_SERVICES+=("$service")
              fi
          done
          
          # Docker ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
          log_message "=== Docker ì»¨í…Œì´ë„ˆ ìƒíƒœ ==="
          CONTAINERS=$(docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep -v NAMES)
          if [ -n "$CONTAINERS" ]; then
              echo "$CONTAINERS" | while read line; do
                  log_message "  $line"
              done
          else
              log_message "  ê²½ê³ : ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆê°€ ì—†ìŠµë‹ˆë‹¤"
          fi
          
          # ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ í™•ì¸
          DISK_USAGE=$(df -h / | awk 'NR==2 {print $5}' | sed 's/%//')
          log_message "=== ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰: ${DISK_USAGE}% ==="
          if [ "$DISK_USAGE" -gt 80 ]; then
              log_message "  ê²½ê³ : ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ì´ 80%ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤"
          fi
          
          # ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í™•ì¸
          MEMORY_USAGE=$(free | awk 'NR==2{printf "%.1f", $3*100/$2}')
          log_message "=== ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: ${MEMORY_USAGE}% ==="
          if (( $(echo "$MEMORY_USAGE > 80" | bc -l) )); then
              log_message "  ê²½ê³ : ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì´ 80%ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤"
          fi
          
          # ë„¤íŠ¸ì›Œí¬ ì—°ê²° í™•ì¸
          log_message "=== ë„¤íŠ¸ì›Œí¬ ì—°ê²° í™•ì¸ ==="
          PORTS=(3000 8080 8001 8081 8082 3001 9090 9100)
          for port in "${PORTS[@]}"; do
              if netstat -tlnp | grep ":$port " > /dev/null; then
                  log_message "  âœ“ í¬íŠ¸ $port: ì—´ë¦¼"
              else
                  log_message "  âœ— í¬íŠ¸ $port: ë‹«í˜"
              fi
          done
          
          # ê²°ê³¼ ìš”ì•½
          if [ ${#FAILED_SERVICES[@]} -eq 0 ]; then
              log_message "=== ê²°ê³¼: ëª¨ë“  ì„œë¹„ìŠ¤ê°€ ì •ìƒì…ë‹ˆë‹¤ ==="
              exit 0
          else
              log_message "=== ê²°ê³¼: ì‹¤íŒ¨í•œ ì„œë¹„ìŠ¤: ${FAILED_SERVICES[*]} ==="
              exit 2
          fi
        dest: "/opt/{{ project_name }}/health-check.sh"
        mode: '0755'
      tags: [monitoring]

    # ================================================
    # 12. Cron ì‘ì—… ì„¤ì • (ê°œì„ ëœ ë²„ì „)
    # ================================================
    - name: Cron ì‘ì—… ì„¤ì • (ê°œì„ ëœ ë²„ì „)
      cron:
        name: "{{ item.name }}"
        minute: "{{ item.minute }}"
        hour: "{{ item.hour | default('*') }}"
        job: "{{ item.job }}"
      loop:
        - name: "LifeBit í—¬ìŠ¤ì²´í¬"
          minute: "*/5"
          job: "/opt/{{ project_name }}/health-check.sh > /dev/null 2>&1"
        - name: "ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—…"
          minute: "0"
          hour: "3"
          job: "cd /opt/{{ project_name }} && docker-compose exec -T postgres-db pg_dump -U {{ postgres_user | default('lifebit_user') }} {{ postgres_db | default('lifebit_db') }} > /opt/{{ project_name }}/backups/db_backup_$(date +%Y%m%d_%H%M%S).sql"
        - name: "Docker ì •ë¦¬"
          minute: "0"
          hour: "2"
          job: "docker system prune -f > /dev/null 2>&1"
        - name: "ë¡œê·¸ ì •ë¦¬"
          minute: "0"
          hour: "4"
          job: "find /opt/{{ project_name }}/logs -name '*.log' -mtime +7 -delete > /dev/null 2>&1"
      tags: [monitoring]

    # ================================================
    # 13. ë¡œê·¸ ë¡œí…Œì´ì…˜ ì„¤ì •
    # ================================================
    - name: ë¡œê·¸ ë¡œí…Œì´ì…˜ ì„¤ì •
      copy:
        content: |
          /opt/{{ project_name }}/logs/*.log {
              daily
              missingok
              rotate 30
              compress
              delaycompress
              notifempty
              create 644 root root
              postrotate
                  systemctl reload docker || true
              endscript
          }
        dest: /etc/logrotate.d/lifebit
      tags: [system]

    # ================================================
    # 14. ì‹œìŠ¤í…œ ì •ë³´ ìˆ˜ì§‘
    # ================================================
    - name: ì‹œìŠ¤í…œ ì •ë³´ íŒŒì¼ ìƒì„±
      copy:
        content: |
          === LifeBit ì„œë²„ ì •ë³´ ===
          ë°°í¬ ì™„ë£Œ ì‹œê°„: {{ ansible_date_time.iso8601 }}
          í™˜ê²½: {{ environment }}
          í”„ë¡œì íŠ¸: {{ project_name }}
          
          === ì‹œìŠ¤í…œ ì •ë³´ ===
          OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          Kernel: {{ ansible_kernel }}
          CPU: {{ ansible_processor_vcpus }} cores
          Memory: {{ ansible_memtotal_mb }} MB
          
          === ë„¤íŠ¸ì›Œí¬ ì •ë³´ ===
          Public IP: {{ ansible_default_ipv4.address }}
          
          === ì„œë¹„ìŠ¤ í¬íŠ¸ ===
          - Frontend: 3000
          - Spring Boot API: 8080
          - FastAPI: 8001
          - Airflow: 8081
          - Nginx Proxy: 8082
          - Grafana: 3001
          - Prometheus: 9090
          - Node Exporter: 9100
        dest: "/opt/{{ project_name }}/system-info.txt"
      tags: [info]

    # ================================================
    # 15. ë°°í¬ ì™„ë£Œ ì•Œë¦¼
    # ================================================
    - name: ë°°í¬ ì™„ë£Œ í‘œì‹œ
      file:
        path: "/opt/{{ project_name }}/deployment-complete"
        state: touch
        mode: '0644'
      tags: [deploy]

    - name: ë°°í¬ ì™„ë£Œ ë©”ì‹œì§€ ì¶œë ¥
      debug:
        msg: |
          ğŸ‰ LifeBit ë°°í¬ ì™„ë£Œ!
          
          ğŸ“± ì„œë¹„ìŠ¤ URLs:
          - í†µí•© ì ‘ì† (Nginx): http://{{ ansible_default_ipv4.address }}:8082
          - Frontend: http://{{ ansible_default_ipv4.address }}:3000
          - Spring Boot API: http://{{ ansible_default_ipv4.address }}:8080
          - FastAPI: http://{{ ansible_default_ipv4.address }}:8001
          - Grafana: http://{{ ansible_default_ipv4.address }}:3001
          - Prometheus: http://{{ ansible_default_ipv4.address }}:9090
          
          ğŸ”‘ SSH ì ‘ì†:
          ssh -i ~/.ssh/lifebit-{{ environment }}-key.pem ubuntu@{{ ansible_default_ipv4.address }}
      tags: [info]

  handlers:
    - name: restart docker
      systemd:
        name: docker
        state: restarted
    
    - name: restart ssh
      systemd:
        name: ssh
        state: restarted 