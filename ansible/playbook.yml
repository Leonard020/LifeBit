---
# ================================================
# LifeBit í•™ì›ìš© Ansible ë°°í¬ í”Œë ˆì´ë¶
# ================================================
# ë‹¨ì¼ ì„œë²„ì— Docker Composeë¡œ ëª¨ë“  ì„œë¹„ìŠ¤ ë°°í¬

- name: Deploy LifeBit Application to NCP (Academy Version)
  hosts: lifebit_servers
  become: yes
  vars:
    project_name: "lifebit"
    environment: "{{ env | default('demo') }}"
    project_path: "/opt/lifebit"
    git_repo: "{{ git_repository_url | default('https://github.com/your-username/LifeBit.git') }}"
    git_branch: "{{ git_branch | default('main') }}"
    
  tasks:
    # ================================================
    # ì‹œìŠ¤í…œ ê¸°ë³¸ ì„¤ì •
    # ================================================
    - name: Update system packages
      apt:
        update_cache: yes
        upgrade: dist
        cache_valid_time: 3600
      tags: [system, setup]

    - name: Install required system packages
      apt:
        name:
          - curl
          - wget
          - git
          - docker.io
          - docker-compose
          - python3-pip
          - python3-docker
          - htop
          - vim
          - unzip
          - tree
          - jq
        state: present
      tags: [system, setup]

    - name: Install Docker Compose v2
      shell: |
        curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
        chmod +x /usr/local/bin/docker-compose
      args:
        creates: /usr/local/bin/docker-compose
      tags: [system, setup]

    - name: Start and enable Docker service
      systemd:
        name: docker
        state: started
        enabled: yes
      tags: [system, setup]

    - name: Add root user to docker group
      user:
        name: root
        groups: docker
        append: yes
      tags: [system, setup]

    # ================================================
    # í”„ë¡œì íŠ¸ ì„¤ì •
    # ================================================
    - name: Create project directory
      file:
        path: "{{ project_path }}"
        state: directory
        owner: root
        group: root
        mode: '0755'
      tags: [setup, deploy]

    - name: Clone or update repository
      git:
        repo: "{{ git_repo }}"
        dest: "{{ project_path }}"
        version: "{{ git_branch }}"
        force: yes
      tags: [deploy]
      register: git_result

    - name: Check if .env file exists
      stat:
        path: "{{ project_path }}/.env"
      register: env_file
      tags: [config]

    - name: Create main .env file if not exists
      copy:
        content: |
          # ================================================
          # LifeBit í•™ì›ìš© í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          # ================================================
          
          # ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • (PostgreSQL)
          POSTGRES_DB=lifebit_db
          POSTGRES_USER=lifebit_user
          POSTGRES_PASSWORD=lifebit_secure_password_123
          POSTGRES_PORT=5432
          
          # Redis ì„¤ì •
          REDIS_PASSWORD=lifebit_redis_secure_pass
          REDIS_PORT=6379
          
          # Spring Boot ì„¤ì •
          SPRING_PROFILES_ACTIVE={{ environment }}
          JWT_SECRET=your-jwt-secret-key-here-32-characters-minimum
          
          # AI API ì„¤ì •
          OPENAI_API_KEY={{ openai_api_key | default('your-api-key-here') }}
          USE_GPT={{ use_gpt | default('False') }}
          
          # ì†Œì…œ ë¡œê·¸ì¸ ì„¤ì • (ì„ íƒì )
          KAKAO_REDIRECT_URI={{ kakao_redirect_uri | default('') }}
          GOOGLE_CLIENT_SECRET={{ google_client_secret | default('') }}
          GOOGLE_REDIRECT_URI={{ google_redirect_uri | default('') }}
          
          # Airflow ì„¤ì •
          AIRFLOW_FERNET_KEY={{ airflow_fernet_key | default('') }}
          AIRFLOW_ADMIN_USER=admin
          AIRFLOW_ADMIN_PASSWORD=admin123
          
          # Grafana ì„¤ì •
          GRAFANA_ADMIN_USER=admin
          GRAFANA_ADMIN_PASSWORD=grafana_secure_password
          
          # ë©”ëª¨ë¦¬ ì œí•œ (í•™ì›ìš© ìµœì í™”)
          POSTGRES_MAX_MEMORY=512
          REDIS_MAX_MEMORY=256
          
          # í™˜ê²½ ì •ë³´
          ENVIRONMENT={{ environment }}
          PROJECT_NAME={{ project_name }}
        dest: "{{ project_path }}/.env"
        owner: root
        group: root
        mode: '0600'
      when: not env_file.stat.exists
      tags: [config]

    - name: Install Python cryptography for Fernet key generation
      pip:
        name: cryptography
        state: present
      tags: [config]

    - name: Generate Airflow Fernet key if not set
      shell: python3 -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"
      register: fernet_key
      changed_when: false
      tags: [config]
      when: airflow_fernet_key is not defined or airflow_fernet_key == ""

    - name: Update .env with generated Fernet key
      lineinfile:
        path: "{{ project_path }}/.env"
        regexp: '^AIRFLOW_FERNET_KEY='
        line: "AIRFLOW_FERNET_KEY={{ fernet_key.stdout }}"
      when: fernet_key.stdout is defined
      tags: [config]

    # ================================================
    # ê¸°ì¡´ ì„œë¹„ìŠ¤ ì •ë¦¬
    # ================================================
    - name: Stop existing containers gracefully
      community.docker.docker_compose:
        project_src: "{{ project_path }}"
        files:
          - docker-compose.single-server.yml
        state: absent
        timeout: 60
      ignore_errors: yes
      tags: [deploy, cleanup]

    - name: Clean up unused Docker resources
      shell: |
        docker system prune -f
        docker volume prune -f
      tags: [deploy, cleanup]

    # ================================================
    # ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬
    # ================================================
    - name: Build Docker images
      shell: |
        cd {{ project_path }}
        docker-compose -f docker-compose.single-server.yml build --parallel
      tags: [deploy, build]
      register: build_result
      failed_when: build_result.rc != 0

    - name: Start all services with Docker Compose
      community.docker.docker_compose:
        project_src: "{{ project_path }}"
        files:
          - docker-compose.single-server.yml
        state: present
        timeout: 300
      tags: [deploy]
      register: compose_result

    - name: Wait for services to be ready
      wait_for:
        port: "{{ item }}"
        host: localhost
        delay: 30
        timeout: 300
      loop:
        - 5432  # PostgreSQL
        - 6379  # Redis
        - 8080  # Spring Boot
        - 8001  # FastAPI
        - 3000  # Frontend
        - 8082  # Nginx Proxy
      tags: [deploy, verify]

    # ================================================
    # ë°°í¬ ê²€ì¦
    # ================================================
    - name: Check service health
      uri:
        url: "http://localhost:{{ item.port }}{{ item.path | default('') }}"
        method: GET
        status_code: [200, 404]  # 404ë„ í—ˆìš© (ì„œë¹„ìŠ¤ê°€ ì‹¤í–‰ ì¤‘ì´ë©´)
      loop:
        - { port: 8080, path: "/actuator/health" }
        - { port: 8001, path: "/docs" }
        - { port: 3000, path: "/" }
        - { port: 8082, path: "/" }
        - { port: 3001, path: "/" }
        - { port: 9090, path: "/" }
      ignore_errors: yes
      tags: [deploy, verify]
      register: health_checks

    - name: Display service status
      debug:
        msg: |
          ğŸ‰ LifeBit í•™ì›ìš© ë°°í¬ ì™„ë£Œ!
          
          ğŸ“‹ ì„œë¹„ìŠ¤ ìƒíƒœ:
          {% for check in health_checks.results %}
          - {{ check.item.port }}: {{ 'OK' if check.status == 200 else 'STARTING' }}
          {% endfor %}
          
          ğŸŒ ì ‘ì† URLs:
          - Frontend:     http://{{ ansible_default_ipv4.address }}:3000
          - Spring API:   http://{{ ansible_default_ipv4.address }}:8080
          - FastAPI:      http://{{ ansible_default_ipv4.address }}:8001
          - Nginx Proxy:  http://{{ ansible_default_ipv4.address }}:8082
          - Grafana:      http://{{ ansible_default_ipv4.address }}:3001 (admin/grafana_secure_password)
          - Prometheus:   http://{{ ansible_default_ipv4.address }}:9090
          - Airflow:      http://{{ ansible_default_ipv4.address }}:8081 (admin/admin123)
          
          ğŸ”§ ìœ ìš©í•œ ëª…ë ¹ì–´:
          - ì„œë¹„ìŠ¤ ìƒíƒœ: docker ps
          - ë¡œê·¸ ë³´ê¸°: docker-compose -f docker-compose.single-server.yml logs -f [service]
          - ì„œë¹„ìŠ¤ ì¬ì‹œì‘: docker-compose -f docker-compose.single-server.yml restart [service]
      tags: [deploy, verify]

    # ================================================
    # ì‹œìŠ¤í…œ ìµœì í™” (ì„ íƒì )
    # ================================================
    - name: Configure system for Docker optimization
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        reload: yes
      loop:
        - { name: "vm.max_map_count", value: "262144" }
        - { name: "fs.file-max", value: "65536" }
      tags: [optimize]
      ignore_errors: yes

    - name: Create Docker daemon configuration for optimization
      copy:
        content: |
          {
            "log-driver": "json-file",
            "log-opts": {
              "max-size": "10m",
              "max-file": "3"
            },
            "storage-driver": "overlay2"
          }
        dest: /etc/docker/daemon.json
        owner: root
        group: root
        mode: '0644'
      tags: [optimize]
      notify: restart docker

    - name: Setup log rotation for application logs
      copy:
        content: |
          /opt/lifebit/logs/*.log {
            daily
            missingok
            rotate 7
            compress
            delaycompress
            notifempty
            create 644 root root
          }
        dest: /etc/logrotate.d/lifebit
        owner: root
        group: root
        mode: '0644'
      tags: [optimize]

  handlers:
    - name: restart docker
      systemd:
        name: docker
        state: restarted 